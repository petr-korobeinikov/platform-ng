# Observability

Примеры кода можно найти в демонстрационном
сервисе `reference-observable-service` в каталоге `platform-showcase`.

## Tracing

* Всегда передавайте первым аргументом `context.Context`. Особенно это важно для
  функций и методов:
    * в которых происходит сетевое взаимодействие.
    * в которых идёт долгий и сложный процесс вычислений.
* При входе в функцию стартуйте **новый** спан.
* Перепишите контекст, вернувшийся из функции старта спана. Это важно для
  сохранения порядка и вложенности спанов.
  ```go
  span, ctx := tracing.SpanStartFromContext(ctx)
  ```
* Идеальный трейс должен выглядеть как на изображении ниже.
    * Все спаны вложены в корневой спан.
    * По трейсу легко отследить ход выполнения программы.
    * Легко видеть, какая операция сколько времени заняла в разрезе всего
      трейса.
      ![Идеально выглядящий трейс](asset/tracing_trace_example.png)

## Metrics

* Golden Signals
    * [https://sre.google/sre-book/monitoring-distributed-systems/](https://sre.google/sre-book/monitoring-distributed-systems/)
* Разделяйте счётчики количества операций (запросов, долгих вычислений) на
  успешные и не успешные.
* Не дублируйте метрику, если её можно вывести из других метрик.
    * Например `_total` можно вывести из суммы `_count_success`
      и `_count_failed`.
    * Хранение дополнительного временного ряда для системы мониторинга может
      оказаться тяжелее, чем подчёт агрегации. Это утверждение вступает в силу
      при наличии большого количества метрик с большого количества сервисов.

## Logging

* Старайтесь логгировать ошибку на самом верхнем уровне исполнения.
    * Логгирование возвращаемой ошибки несоклько раз привёдет к её дублированию
      в `sentry` с разными сообщениями. Фактически это будет одна и та же
      ошибка, зафиксированная в логе несколько раз.
* Получайте экземпляр логгера и заполняйте уже известные на момент логгирования
  данные вычислений:
  ```go
  logger := logging.GetLogger().With("person_id", 1337).With("item_id", 9999)
  ```
* Фиксируйте результаты вычислений в полях структурированного логгера.
  ```go
  logger.Debug("completing heavy counting operation", logger.Field("result", 42))
  ```
